<?php

echo "ðŸ§ª Test de l'API SMS via l'interface web\n";
echo "========================================\n\n";

// Simuler une session admin
session_start();
$_SESSION['user'] = [
    'id' => 7,
    'email' => 'momo@gmail.com',
    'name' => 'Momo',
    'role' => 'admin',
    'is_admin' => true
];
$_SESSION['authenticated'] = true;
$_SESSION['last_activity'] = time();

echo "âœ… Session admin simulÃ©e\n\n";

// Test de l'API "Tester SMS"
echo "ðŸ“¤ Test de l'API /notifications/preferences/test-sms\n";
echo "===================================================\n";

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, 'http://localhost:8888/notifications/preferences/test-sms');
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
curl_setopt($ch, CURLOPT_COOKIE, session_name() . '=' . session_id());

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$finalUrl = curl_getinfo($ch, CURLINFO_EFFECTIVE_URL);
curl_close($ch);

echo "ðŸ“‹ Code HTTP: $httpCode\n";
echo "ðŸ”— URL finale: $finalUrl\n";

// Analyser la rÃ©ponse
if ($httpCode === 302) {
    // Redirection - analyser l'URL de redirection
    if (strpos($finalUrl, 'test_sms=success') !== false) {
        echo "âœ… SMS de test envoyÃ© avec succÃ¨s !\n";
    } elseif (strpos($finalUrl, 'test_sms=error') !== false) {
        echo "âŒ Erreur lors de l'envoi du SMS de test\n";
    } elseif (strpos($finalUrl, 'error=no_phone') !== false) {
        echo "âŒ Pas de numÃ©ro de tÃ©lÃ©phone configurÃ©\n";
    } else {
        echo "ðŸ”„ Redirection vers: $finalUrl\n";
    }
} else {
    echo "ðŸ“„ RÃ©ponse (premiers 500 caractÃ¨res):\n";
    echo substr($response, 0, 500) . "\n";
}

// VÃ©rifier les logs
echo "\nðŸ“Š VÃ©rification des logs SMS\n";
echo "============================\n";

$logFiles = [
    'logs/app.log',
    'logs/sms_test.log'
];

foreach ($logFiles as $logFile) {
    if (file_exists($logFile)) {
        echo "ðŸ“„ Contenu de $logFile (derniÃ¨res lignes):\n";
        $lines = file($logFile);
        $lastLines = array_slice($lines, -5); // 5 derniÃ¨res lignes
        foreach ($lastLines as $line) {
            echo "   " . trim($line) . "\n";
        }
        echo "\n";
    } else {
        echo "âš ï¸ Fichier $logFile non trouvÃ©\n";
    }
}

// VÃ©rifier l'Ã©tat des prÃ©fÃ©rences SMS
echo "ðŸ“‹ VÃ©rification des prÃ©fÃ©rences SMS actuelles\n";
echo "=============================================\n";

try {
    $host = "localhost";
    $dbname = "exemple";
    $username = "root";
    $password = "root";
    $port = 8889;
    
    $pdo = new PDO(
        "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4",
        $username,
        $password,
        [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
    );
    
    $stmt = $pdo->prepare("
        SELECT u.name, u.phone, np.sms_notifications, np.intervention_assignments, np.maintenance_reminders, np.critical_alerts
        FROM users u 
        LEFT JOIN notification_preferences np ON u.id = np.user_id 
        WHERE u.role = 'admin' 
        LIMIT 1
    ");
    $stmt->execute();
    $result = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($result) {
        echo "ðŸ‘¤ Utilisateur: {$result['name']}\n";
        echo "ðŸ“± TÃ©lÃ©phone: {$result['phone']}\n";
        echo "ðŸ“Š PrÃ©fÃ©rences SMS:\n";
        echo "   - SMS gÃ©nÃ©rales: " . ($result['sms_notifications'] ? 'âœ… ActivÃ©' : 'âŒ DÃ©sactivÃ©') . "\n";
        echo "   - Interventions: " . ($result['intervention_assignments'] ? 'âœ… ActivÃ©' : 'âŒ DÃ©sactivÃ©') . "\n";
        echo "   - Entretien: " . ($result['maintenance_reminders'] ? 'âœ… ActivÃ©' : 'âŒ DÃ©sactivÃ©') . "\n";
        echo "   - Alertes: " . ($result['critical_alerts'] ? 'âœ… ActivÃ©' : 'âŒ DÃ©sactivÃ©') . "\n";
    }
    
} catch (Exception $e) {
    echo "âŒ Erreur base de donnÃ©es: " . $e->getMessage() . "\n";
}

echo "\nðŸ Test terminÃ©\n";
echo "ðŸ’¡ Pour un test complet, allez sur l'interface web et cliquez sur 'Tester SMS'\n";

?>

