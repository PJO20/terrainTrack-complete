<?php
/**
 * Test du contrÃ´leur d'envoi d'email
 */

echo "ðŸ” Test du contrÃ´leur d'envoi d'email\n";
echo "====================================\n\n";

// Simuler une requÃªte POST
$_SERVER['REQUEST_METHOD'] = 'POST';
$_POST = [];

// Inclure les dÃ©pendances nÃ©cessaires
require_once __DIR__ . '/vendor/autoload.php';

try {
    // CrÃ©er les services nÃ©cessaires
    $host = 'localhost';
    $port = '8889';
    $dbname = 'exemple';
    $username = 'root';
    $password = 'root';
    
    $dsn = "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
    
    // CrÃ©er les repositories
    $userRepository = new \App\Repository\UserRepository($pdo);
    $notificationLogsRepository = new \App\Repository\NotificationLogsRepository($pdo);
    $preferencesRepository = new \App\Repository\NotificationPreferencesRepository($pdo);
    
    // CrÃ©er les services
    $emailService = new \App\Service\EmailNotificationService($userRepository, $notificationLogsRepository);
    $smsService = new \App\Service\SmsNotificationService($userRepository, $notificationLogsRepository);
    
    echo "âœ… Services crÃ©Ã©s avec succÃ¨s\n";
    
    // Simuler une session utilisateur
    session_start();
    $_SESSION['user_id'] = 7; // ID de momo@gmail.com
    $_SESSION['user_email'] = 'momo@gmail.com';
    $_SESSION['user_name'] = 'Momo';
    
    echo "âœ… Session simulÃ©e pour momo@gmail.com\n";
    
    // Tester la logique du contrÃ´leur
    echo "ðŸ“§ Test de la logique du contrÃ´leur...\n";
    
    // VÃ©rifier la mÃ©thode POST
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        echo "âŒ MÃ©thode non POST\n";
        exit;
    }
    echo "âœ… MÃ©thode POST dÃ©tectÃ©e\n";
    
    // Simuler getCurrentUser()
    $userId = 7; // ID de momo@gmail.com
    echo "âœ… User ID: $userId\n";
    
    // RÃ©cupÃ©rer l'utilisateur et les prÃ©fÃ©rences
    $user = $userRepository->findById($userId);
    $preferences = $preferencesRepository->findByUserId($userId);
    
    if (!$user) {
        echo "âŒ Utilisateur non trouvÃ©\n";
        exit;
    }
    echo "âœ… Utilisateur trouvÃ©: " . $user->getName() . " (" . $user->getEmail() . ")\n";
    
    if (!$preferences) {
        echo "âŒ PrÃ©fÃ©rences non trouvÃ©es\n";
        exit;
    }
    echo "âœ… PrÃ©fÃ©rences trouvÃ©es\n";
    
    // Tester l'envoi d'email
    $email = $user->getEmail();
    echo "ðŸ“§ Envoi d'email Ã : $email\n";
    
    $success = $emailService->sendTestEmailWithPreferences($email, $preferences, $user);
    
    if ($success) {
        echo "âœ… Email envoyÃ© avec succÃ¨s !\n";
        echo "ðŸ“§ VÃ©rifiez votre boÃ®te email\n";
        echo "ðŸ”„ Redirection vers: /notifications/preferences?test_email=success\n";
    } else {
        echo "âŒ Ã‰chec de l'envoi de l'email\n";
        echo "ðŸ”„ Redirection vers: /notifications/preferences?test_email=error\n";
    }
    
} catch (Exception $e) {
    echo "âŒ Erreur: " . $e->getMessage() . "\n";
    echo "ðŸ“ Fichier: " . $e->getFile() . ":" . $e->getLine() . "\n";
}

echo "\nðŸ” Test terminÃ© !\n";
?>

