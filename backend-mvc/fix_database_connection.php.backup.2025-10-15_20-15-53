<?php
/**
 * Script pour corriger la connexion √† la base de donn√©es
 */

error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "üîß Correction de la connexion √† la base de donn√©es\n";
echo "===============================================\n\n";

// Configuration directe de la base de donn√©es MAMP
$dbHost = 'localhost';
$dbName = 'exemple';
$dbUser = 'root';
$dbPass = 'root';
$dbPort = 8889;

echo "1. üîç Test de connexion directe...\n";
echo "   - Serveur : {$dbHost}:{$dbPort}\n";
echo "   - Base : {$dbName}\n";
echo "   - Utilisateur : {$dbUser}\n\n";

try {
    // Test de connexion directe
    $db = new PDO(
        "mysql:host={$dbHost};port={$dbPort};dbname={$dbName};charset=utf8mb4",
        $dbUser,
        $dbPass,
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false,
        ]
    );
    echo "   ‚úÖ Connexion directe r√©ussie !\n\n";
    
    echo "2. üìù Cr√©ation du fichier .env...\n";
    
    $envContent = "# Configuration de la base de donn√©es
DB_HOST=localhost
DB_NAME=exemple
DB_USER=root
DB_PASS=root
DB_PORT=8889

# Configuration SMTP Gmail
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=pjorsini20@gmail.com
SMTP_PASSWORD=gmqncgtfunpfnkjh
FROM_EMAIL=noreply@terraintrack.com
FROM_NAME=TerrainTrack

# Configuration de l'application
APP_DEBUG=true
APP_ENV=development";

    // Cr√©er le fichier .env
    $envFile = __DIR__ . '/.env';
    $result = file_put_contents($envFile, $envContent);
    
    if ($result !== false) {
        echo "   ‚úÖ Fichier .env cr√©√© avec succ√®s !\n";
        echo "   üìÅ Emplacement : {$envFile}\n";
    } else {
        echo "   ‚ùå Erreur lors de la cr√©ation du fichier .env\n";
    }
    
    echo "\n3. üîß Modification de la configuration database.php...\n";
    
    // Lire le fichier database.php actuel
    $databaseFile = __DIR__ . '/config/database.php';
    $databaseContent = file_get_contents($databaseFile);
    
    // Remplacer la configuration par une configuration directe
    $newDatabaseContent = '<?php

// Configuration directe de la base de donn√©es MAMP
$host = "localhost";
$dbname = "exemple";
$username = "root";
$password = "root";
$port = 8889;

try {
    $db = new PDO(
        "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4",
        $username,
        $password,
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false,
            PDO::ATTR_PERSISTENT => false, // S√©curit√©
            PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT => false, // √Ä true en production avec SSL
        ]
    );
    return $db;
} catch (PDOException $e) {
    // Log l\'erreur sans exposer les d√©tails
    error_log("Database connection error: " . $e->getMessage());
    
    if (true) { // Mode debug activ√©
        die("Erreur de connexion √† la base de donn√©es : " . $e->getMessage());
    } else {
        die("Erreur de connexion √† la base de donn√©es. Veuillez contacter l\'administrateur.");
    }
}';
    
    $result = file_put_contents($databaseFile, $newDatabaseContent);
    
    if ($result !== false) {
        echo "   ‚úÖ Configuration database.php mise √† jour !\n";
    } else {
        echo "   ‚ùå Erreur lors de la mise √† jour de database.php\n";
    }
    
    echo "\n4. üß™ Test de la nouvelle configuration...\n";
    
    // Tester la nouvelle configuration
    require_once $databaseFile;
    $testDb = require $databaseFile;
    
    if ($testDb instanceof PDO) {
        echo "   ‚úÖ Configuration database.php fonctionne !\n";
        
        // Test d'une requ√™te simple
        $stmt = $testDb->query("SELECT COUNT(*) as count FROM users");
        $result = $stmt->fetch();
        echo "   ‚úÖ Requ√™te test r√©ussie : {$result['count']} utilisateurs trouv√©s\n";
    } else {
        echo "   ‚ùå Probl√®me avec la nouvelle configuration\n";
    }
    
    echo "\n" . str_repeat("=", 50) . "\n";
    echo "‚úÖ CONNEXION √Ä LA BASE DE DONN√âES CORRIG√âE !\n";
    echo str_repeat("=", 50) . "\n";
    
    echo "\nüöÄ Votre application TerrainTrack devrait maintenant fonctionner !\n";
    echo "üì± Acc√©dez √† : http://localhost:8889/exemple/backend-mvc/public/\n";
    
} catch (PDOException $e) {
    echo "‚ùå ERREUR DE BASE DE DONN√âES : " . $e->getMessage() . "\n";
    echo "V√©rifiez que MAMP est d√©marr√© et que la base 'exemple' existe.\n";
} catch (Exception $e) {
    echo "‚ùå ERREUR : " . $e->getMessage() . "\n";
}
?>
