<?php
/**
 * Test du système de fréquence dynamique
 */

echo "🧪 Test du système de fréquence dynamique\n";
echo "========================================\n\n";

// Configuration
$host = 'localhost';
$port = '8889';
$dbname = 'exemple';
$username = 'root';
$password = 'root';

try {
    $dsn = "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
    
    echo "✅ Connexion à la base de données réussie !\n\n";
    
    // 1. Vérifier les préférences actuelles
    echo "1. 📋 Préférences de fréquence actuelles :\n";
    $sql = "SELECT u.id, u.name, u.email, 
                   COALESCE(np.reminder_frequency_days, 7) as reminder_frequency_days,
                   COALESCE(np.maintenance_reminders, 1) as maintenance_reminders
            FROM users u
            LEFT JOIN notification_preferences np ON u.id = np.user_id
            WHERE u.is_active = 1
            ORDER BY u.id";
    
    $stmt = $pdo->prepare($sql);
    $stmt->execute();
    $users = $stmt->fetchAll();
    
    foreach ($users as $user) {
        $status = $user['maintenance_reminders'] ? '✅ Activé' : '❌ Désactivé';
        echo "   - " . ($user['name'] ?? 'Utilisateur') . " (ID: {$user['id']}) : {$user['reminder_frequency_days']} jours - $status\n";
    }
    
    // 2. Tester différentes fréquences
    echo "\n2. 🔧 Test de modification des fréquences :\n";
    
    // Modifier la fréquence pour l'utilisateur ID 7 (Momo)
    $newFrequency = 3; // 3 jours au lieu de 7
    $sql = "INSERT INTO notification_preferences (user_id, reminder_frequency_days, maintenance_reminders, email_notifications)
            VALUES (7, ?, 1, 1)
            ON DUPLICATE KEY UPDATE 
            reminder_frequency_days = ?,
            updated_at = CURRENT_TIMESTAMP";
    
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$newFrequency, $newFrequency]);
    
    echo "   ✅ Fréquence modifiée pour Momo : $newFrequency jours\n";
    
    // 3. Simuler la logique du cron
    echo "\n3. 🎯 Simulation de la logique du cron :\n";
    
    foreach ($users as $user) {
        $userId = $user['id'];
        $userName = $user['name'] ?? 'Utilisateur';
        
        // Récupérer la fréquence mise à jour
        $sql = "SELECT COALESCE(reminder_frequency_days, 7) as frequency 
                FROM notification_preferences 
                WHERE user_id = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$userId]);
        $freq = $stmt->fetch();
        $frequency = $freq ? $freq['frequency'] : 7;
        
        echo "\n   👤 $userName (fréquence: $frequency jours) :\n";
        
        // Vérifier les entretiens dans cette plage
        $sql = "SELECT id, vehicle_name, maintenance_type, due_date,
                       DATEDIFF(due_date, NOW()) as days_until_due
                FROM maintenance_schedules 
                WHERE due_date BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL ? DAY)
                AND status = 'scheduled'";
        
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$frequency]);
        $upcoming = $stmt->fetchAll();
        
        if (empty($upcoming)) {
            echo "      ⚪ Aucun entretien dans les $frequency prochains jours\n";
        } else {
            foreach ($upcoming as $maintenance) {
                $vehicleName = $maintenance['vehicle_name'] ?? 'Véhicule #' . $maintenance['id'];
                $daysUntil = $maintenance['days_until_due'];
                echo "      🔧 $vehicleName - {$maintenance['maintenance_type']} dans $daysUntil jour(s)\n";
            }
        }
    }
    
    // 4. Test du formulaire web
    echo "\n4. 🌐 Test de l'interface web :\n";
    echo "   💡 Allez sur http://localhost:8888/notifications/preferences\n";
    echo "   📝 Modifiez la fréquence des rappels (actuellement 3 jours pour Momo)\n";
    echo "   💾 Sauvegardez et vérifiez que la valeur est bien enregistrée\n";
    
    // 5. Afficher la requête SQL pour le cron
    echo "\n5. 📋 Requête SQL utilisée par le cron dynamique :\n";
    echo "   SELECT * FROM maintenance_schedules \n";
    echo "   WHERE due_date BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL [FREQUENCE_UTILISATEUR] DAY)\n";
    echo "   AND status = 'scheduled'\n";
    
} catch (Exception $e) {
    echo "❌ Erreur: " . $e->getMessage() . "\n";
}

echo "\n🎉 Test terminé !\n";
echo "\n🚀 Prochaines étapes :\n";
echo "1. Testez l'interface web pour modifier les fréquences\n";
echo "2. Lancez le script dynamique : php reminder_cron_dynamic.php\n";
echo "3. Vérifiez que chaque utilisateur reçoit des rappels selon sa fréquence\n";
?>


