<?php
/**
 * Script pour forcer la mise Ã  jour de l'email de notification
 */

echo "ðŸ”§ Mise Ã  jour forcÃ©e de l'email de notification\n";
echo "===============================================\n\n";

// Inclure les dÃ©pendances
require_once __DIR__ . '/vendor/autoload.php';

try {
    // Connexion Ã  la base de donnÃ©es
    $host = 'localhost';
    $port = '8889';
    $dbname = 'exemple';
    $username = 'root';
    $password = 'root';
    
    $dsn = "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
    
    // 1. VÃ©rifier l'Ã©tat actuel
    echo "1. ðŸ“‹ Ã‰tat actuel de l'utilisateur ID 7 :\n";
    $stmt = $pdo->prepare("SELECT id, email, notification_email FROM users WHERE id = 7");
    $stmt->execute();
    $user = $stmt->fetch();
    
    if ($user) {
        echo "  - ID: " . $user['id'] . "\n";
        echo "  - Email principal: " . $user['email'] . "\n";
        echo "  - Email de notification: " . ($user['notification_email'] ?? 'NULL') . "\n";
    }
    
    // 2. Forcer la mise Ã  jour
    echo "\n2. ðŸ”§ Mise Ã  jour forcÃ©e vers pjorsini20@gmail.com...\n";
    
    $stmt = $pdo->prepare("UPDATE users SET notification_email = :notification_email WHERE id = 7");
    $success = $stmt->execute(['notification_email' => 'pjorsini20@gmail.com']);
    
    if ($success) {
        echo "âœ… Mise Ã  jour SQL rÃ©ussie !\n";
    } else {
        echo "âŒ Ã‰chec de la mise Ã  jour SQL\n";
    }
    
    // 3. VÃ©rifier le rÃ©sultat
    echo "\n3. ðŸ” VÃ©rification aprÃ¨s mise Ã  jour :\n";
    $stmt = $pdo->prepare("SELECT id, email, notification_email FROM users WHERE id = 7");
    $stmt->execute();
    $user = $stmt->fetch();
    
    if ($user) {
        echo "  - ID: " . $user['id'] . "\n";
        echo "  - Email principal: " . $user['email'] . "\n";
        echo "  - Email de notification: " . ($user['notification_email'] ?? 'NULL') . "\n";
    }
    
    // 4. Tester avec le UserRepository
    echo "\n4. ðŸ§ª Test avec UserRepository :\n";
    
    $userRepository = new \App\Repository\UserRepository($pdo);
    $userEntity = $userRepository->findById(7);
    
    if ($userEntity) {
        echo "  - Email principal: " . $userEntity->getEmail() . "\n";
        echo "  - Email de notification: " . ($userEntity->getNotificationEmail() ?? 'NULL') . "\n";
    } else {
        echo "âŒ Utilisateur non trouvÃ© via UserRepository\n";
    }
    
} catch (Exception $e) {
    echo "âŒ Erreur: " . $e->getMessage() . "\n";
    echo "ðŸ“ Fichier: " . $e->getFile() . ":" . $e->getLine() . "\n";
}

echo "\nðŸ”§ Test terminÃ© !\n";
?>
