{% extends "base.html.twig" %}

{% block title %}Pr√©f√©rences de Notification - TerrainTrack{% endblock %}

{% block extra_css %}
<style>
    .notification-preferences {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .preferences-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .preferences-header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5rem;
        font-weight: 700;
    }
    
    .preferences-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .preferences-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .preferences-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: 1px solid #e1e5e9;
    }
    
    .preferences-card h3 {
        color: #2d3748;
        margin: 0 0 20px 0;
        font-size: 1.4rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .preference-group {
        margin-bottom: 25px;
    }
    
    .preference-group label {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 12px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }
    
    .preference-group label:hover {
        background-color: #f7fafc;
    }
    
    .preference-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #667eea;
    }
    
    .preference-group input[type="number"] {
        width: 80px;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .preference-group .preference-label {
        font-weight: 500;
        color: #4a5568;
    }
    
    .preference-group .preference-description {
        font-size: 0.9rem;
        color: #718096;
        margin-top: 4px;
    }
    
    .contact-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .contact-info h4 {
        margin: 0 0 15px 0;
        color: #2d3748;
        font-size: 1.1rem;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #4a5568;
    }
    
    .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .test-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    
    .test-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }
    
    .test-btn-email {
        background: #48bb78;
        color: white;
    }
    
    .test-btn-email:hover {
        background: #38a169;
    }
    
    .test-btn-sms {
        background: #ed8936;
        color: white;
    }
    
    .test-btn-sms:hover {
        background: #dd6b20;
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: 1px solid #e1e5e9;
        margin-bottom: 30px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #718096;
        font-size: 0.9rem;
    }
    
    .recent-logs {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .log-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .log-item:last-child {
        border-bottom: none;
    }
    
    .log-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .log-type {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .log-type-email {
        background: #e6fffa;
        color: #234e52;
    }
    
    .log-type-sms {
        background: #fef5e7;
        color: #744210;
    }
    
    .log-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .log-status-sent {
        background: #d4edda;
        color: #155724;
    }
    
    .log-status-failed {
        background: #f8d7da;
        color: #721c24;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 1rem;
        transition: background-color 0.2s;
    }
    
    .btn-primary:hover {
        background: #5a67d8;
    }
    
    .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 1rem;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-secondary:hover {
        background: #cbd5e0;
    }
    
    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .config-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .config-enabled {
        background: #d4edda;
        color: #155724;
    }
    
    .config-disabled {
        background: #f8d7da;
        color: #721c24;
    }
    
    @media (max-width: 768px) {
        .preferences-grid {
            grid-template-columns: 1fr;
        }
        
        .test-buttons {
            flex-direction: column;
        }
        
        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="notification-preferences">
    <div class="preferences-header">
        <h1>üîî Pr√©f√©rences de Notification</h1>
        <p>Configurez vos pr√©f√©rences de notification pour rester inform√© des interventions et entretiens</p>
    </div>

    {% if app.request.query.get('success') %}
        <div class="alert alert-success">
            ‚úÖ Vos pr√©f√©rences de notification ont √©t√© mises √† jour avec succ√®s !
        </div>
    {% endif %}

    {% if app.request.query.get('error') %}
        <div class="alert alert-error">
            ‚ùå Une erreur est survenue lors de la mise √† jour de vos pr√©f√©rences.
        </div>
    {% endif %}

    {% if app.request.query.get('test_email') == 'success' %}
        <div class="alert alert-success">
            ‚úÖ Email de test envoy√© avec succ√®s !
        </div>
    {% elseif app.request.query.get('test_email') == 'error' %}
        <div class="alert alert-error">
            ‚ùå √âchec de l'envoi de l'email de test.
        </div>
    {% endif %}

    {% if app.request.query.get('test_sms') == 'success' %}
        <div class="alert alert-success">
            ‚úÖ SMS de test envoy√© avec succ√®s !
        </div>
    {% elseif app.request.query.get('test_sms') == 'error' %}
        <div class="alert alert-error">
            ‚ùå √âchec de l'envoi du SMS de test.
        </div>
    {% endif %}

    {% if app.request.query.get('error') == 'no_phone' %}
        <div class="alert alert-warning">
            ‚ö†Ô∏è Aucun num√©ro de t√©l√©phone configur√©. Veuillez ajouter votre num√©ro pour recevoir des SMS.
        </div>
    {% endif %}

    <form method="POST" action="/notifications/preferences/update">
        <div class="preferences-grid">
            <!-- Notifications Email -->
            <div class="preferences-card">
                <h3>üìß Notifications Email</h3>
                
                <div class="contact-info">
                    <h4>Informations de contact</h4>
                    <div class="form-group">
                        <label for="notification_email">Email de notification :</label>
                        <input type="email" id="notification_email" name="notification_email" 
                               value="{{ user.notification_email ?? user.email }}" 
                               placeholder="votre@email.com">
                    </div>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="email_notifications" value="1" 
                               {% if preferences.email_notifications %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Activer les notifications email</div>
                            <div class="preference-description">Recevoir des notifications par email</div>
                        </div>
                    </label>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="intervention_assignments" value="1" 
                               {% if preferences.intervention_assignments %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Assignations d'interventions</div>
                            <div class="preference-description">√ätre notifi√© lors de l'assignation d'une intervention</div>
                        </div>
                    </label>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="maintenance_reminders" value="1" 
                               {% if preferences.maintenance_reminders %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Rappels d'entretien</div>
                            <div class="preference-description">Recevoir des rappels pour les entretiens programm√©s</div>
                        </div>
                    </label>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="critical_alerts" value="1" 
                               {% if preferences.critical_alerts %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Alertes critiques</div>
                            <div class="preference-description">Recevoir des alertes pour les situations critiques</div>
                        </div>
                    </label>
                </div>

                <div class="test-buttons">
                    <button type="submit" formaction="/notifications/preferences/test-email" class="test-btn test-btn-email">
                        üìß Tester l'email
                    </button>
                </div>

                <div style="margin-top: 15px;">
                    <strong>Configuration :</strong>
                    <span class="config-status {% if emailConfig.configured %}config-enabled{% else %}config-disabled{% endif %}">
                        {% if emailConfig.configured %}‚úÖ Configur√©{% else %}‚ùå Non configur√©{% endif %}
                    </span>
                </div>
            </div>

            <!-- Notifications SMS -->
            <div class="preferences-card">
                <h3>üì± Notifications SMS</h3>
                
                <div class="contact-info">
                    <h4>Informations de contact</h4>
                    <div class="form-group">
                        <label for="phone">Num√©ro de t√©l√©phone :</label>
                        <input type="tel" id="phone" name="phone" 
                               value="{{ user.phone ?? '' }}" 
                               placeholder="+33 6 12 34 56 78">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="notification_sms" value="1" 
                                   {% if user.notification_sms %}checked{% endif %}>
                            Activer les notifications SMS
                        </label>
                    </div>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="sms_notifications" value="1" 
                               {% if preferences.sms_notifications %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Activer les notifications SMS</div>
                            <div class="preference-description">Recevoir des notifications par SMS</div>
                        </div>
                    </label>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="intervention_assignments" value="1" 
                               {% if preferences.intervention_assignments %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Assignations d'interventions</div>
                            <div class="preference-description">√ätre notifi√© par SMS lors de l'assignation</div>
                        </div>
                    </label>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="maintenance_reminders" value="1" 
                               {% if preferences.maintenance_reminders %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Rappels d'entretien</div>
                            <div class="preference-description">Recevoir des rappels SMS pour les entretiens</div>
                        </div>
                    </label>
                </div>

                <div class="preference-group">
                    <label>
                        <input type="checkbox" name="critical_alerts" value="1" 
                               {% if preferences.critical_alerts %}checked{% endif %}>
                        <div>
                            <div class="preference-label">Alertes critiques</div>
                            <div class="preference-description">Recevoir des alertes SMS critiques</div>
                        </div>
                    </label>
                </div>

                <div class="test-buttons">
                    <button type="submit" formaction="/notifications/preferences/test-sms" class="test-btn test-btn-sms">
                        üì± Tester le SMS
                    </button>
                </div>

                <div style="margin-top: 15px;">
                    <strong>Configuration :</strong>
                    <span class="config-status {% if smsConfig.configured %}config-enabled{% else %}config-disabled{% endif %}">
                        {% if smsConfig.configured %}‚úÖ Configur√©{% else %}‚ùå Non configur√©{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Fr√©quence des rappels -->
        <div class="preferences-card">
            <h3>‚è∞ Fr√©quence des rappels</h3>
            
            <div class="preference-group">
                <label>
                    <div class="preference-label">Rappels d'entretien (en jours) :</div>
                    <div class="preference-description">Fr√©quence des rappels pour les entretiens √† venir</div>
                    <input type="number" name="reminder_frequency_days" 
                           value="{{ preferences.reminder_frequency_days ?? 7 }}" 
                           min="1" max="30" style="margin-top: 8px;">
                </label>
            </div>
        </div>

        <!-- Statistiques -->
        {% if stats %}
        <div class="stats-card">
            <h3>üìä Statistiques de notification</h3>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ stats.total_notifications }}</div>
                    <div class="stat-label">Total notifications</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.email_stats.sent ?? 0 }}</div>
                    <div class="stat-label">Emails envoy√©s</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.sms_stats.sent ?? 0 }}</div>
                    <div class="stat-label">SMS envoy√©s</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ (stats.email_stats.success_rate ?? 0)|round(1) }}%</div>
                    <div class="stat-label">Taux de succ√®s email</div>
                </div>
            </div>

            {% if stats.recent_logs %}
            <h4>Derni√®res notifications :</h4>
            <div class="recent-logs">
                {% for log in stats.recent_logs %}
                <div class="log-item">
                    <div class="log-info">
                        <span class="log-type log-type-{{ log.notification_type }}">{{ log.notification_type|upper }}</span>
                        <span>{{ log.subject }}</span>
                    </div>
                    <div>
                        <span class="log-status log-status-{{ log.status }}">{{ log.status }}</span>
                        <small style="margin-left: 10px; color: #718096;">
                            {{ log.sent_at|date('d/m/Y H:i') }}
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="action-buttons">
            <button type="submit" class="btn-primary">
                üíæ Sauvegarder les pr√©f√©rences
            </button>
            <a href="/notifications/history" class="btn-secondary">
                üìã Voir l'historique
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validation du formulaire
    const form = document.querySelector('form');
    const emailInput = document.getElementById('notification_email');
    const phoneInput = document.getElementById('phone');
    
    form.addEventListener('submit', function(e) {
        // Validation de l'email
        if (emailInput.value && !isValidEmail(emailInput.value)) {
            e.preventDefault();
            alert('Veuillez entrer une adresse email valide.');
            emailInput.focus();
            return;
        }
        
        // Validation du t√©l√©phone
        if (phoneInput.value && !isValidPhone(phoneInput.value)) {
            e.preventDefault();
            alert('Veuillez entrer un num√©ro de t√©l√©phone valide.');
            phoneInput.focus();
            return;
        }
    });
    
    // Validation en temps r√©el
    emailInput.addEventListener('blur', function() {
        if (this.value && !isValidEmail(this.value)) {
            this.style.borderColor = '#e53e3e';
        } else {
            this.style.borderColor = '#e2e8f0';
        }
    });
    
    phoneInput.addEventListener('blur', function() {
        if (this.value && !isValidPhone(this.value)) {
            this.style.borderColor = '#e53e3e';
        } else {
            this.style.borderColor = '#e2e8f0';
        }
    });
    
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    function isValidPhone(phone) {
        const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
        return phoneRegex.test(phone);
    }
});
</script>
{% endblock %}



