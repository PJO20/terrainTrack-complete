<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Int√©gration Notifications</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #000; }
        .save-btn { background: #2563eb; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .save-btn:hover { background: #1d4ed8; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ''; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .notification-option { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }
        .notification-info { display: flex; align-items: center; gap: 0.75rem; }
        .notification-label { font-weight: 500; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .test-result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
<div class='container'>
    <h1>üîî Test Int√©gration Notifications</h1>
    
    <div class='status info'>
        <strong>üéØ Test complet du syst√®me de notifications</strong><br>
        Ce test v√©rifie que les notifications respectent les pr√©f√©rences utilisateur (email, son, desktop).
    </div>
    
    <!-- Configuration des pr√©f√©rences -->
    <div class="test-section">
        <h2>üìã Configuration des Pr√©f√©rences</h2>
        <form id="notifications-form">
            <div class="notification-group">
                <h3>Canaux de notification</h3>
                <div class="notification-options">
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-envelope'></i>
                            <span class="notification-label">Notifications par email</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="email_notifications" id="email-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-volume-full'></i>
                            <span class="notification-label">Sons de notification</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sound_notifications" id="sound-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-desktop'></i>
                            <span class="notification-label">Notifications bureau</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="desktop_notifications" id="desktop-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="save-btn" id="notifications-save-btn">
                <i class='bx bx-save'></i>
                Sauvegarder les pr√©f√©rences
            </button>
        </form>
    </div>
    
    <!-- Test des notifications -->
    <div class="test-section">
        <h2>üß™ Tests de Notification</h2>
        
        <div class="test-result">
            <h3>Test 1: Notification avec email activ√©</h3>
            <button class="btn btn-success" onclick="testNotificationWithEmail()">
                üìß Tester avec email activ√©
            </button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 2: Notification avec email d√©sactiv√©</h3>
            <button class="btn btn-warning" onclick="testNotificationWithoutEmail()">
                üìß Tester avec email d√©sactiv√©
            </button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 3: Notification avec son activ√©</h3>
            <button class="btn btn-success" onclick="testNotificationWithSound()">
                üîä Tester avec son activ√©
            </button>
            <div id="test3-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 4: Notification avec son d√©sactiv√©</h3>
            <button class="btn btn-warning" onclick="testNotificationWithoutSound()">
                üîä Tester avec son d√©sactiv√©
            </button>
            <div id="test4-result"></div>
        </div>
    </div>
    
    <!-- Log des tests -->
    <div class="test-section">
        <h2>üìù Log des Tests</h2>
        <div id="test-log" class="log"></div>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Effacer le log</button>
    </div>
    
    <div class='status info'>
        <strong>üîß Instructions:</strong><br>
        1. Configurez vos pr√©f√©rences ci-dessus<br>
        2. Sauvegardez les pr√©f√©rences<br>
        3. Testez les diff√©rents sc√©narios<br>
        4. V√©rifiez les r√©sultats dans le log
    </div>
</div>

<script>
// Log des tests
function log(message, type = 'info') {
    const logDiv = document.getElementById('test-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}\n`;
    logDiv.innerHTML += logEntry;
    logDiv.scrollTop = logDiv.scrollHeight;
    
    console.log(`üîî ${message}`);
}

function clearLog() {
    document.getElementById('test-log').innerHTML = '';
}

// Fonction pour afficher les r√©sultats
function showResult(testId, message, type = 'info') {
    const resultDiv = document.getElementById(testId);
    resultDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
}

// Fonction pour simuler l'envoi de notification
function simulateNotification(emailEnabled, soundEnabled, desktopEnabled) {
    log(`üì§ Simulation d'envoi de notification:`);
    log(`   üìß Email: ${emailEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    log(`   üîä Son: ${soundEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    log(`   üñ•Ô∏è Desktop: ${desktopEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    
    // Simuler l'envoi selon les pr√©f√©rences
    if (emailEnabled) {
        log(`   ‚úÖ Email: ENVOY√â (pr√©f√©rence activ√©e)`);
    } else {
        log(`   ‚ùå Email: NON ENVOY√â (pr√©f√©rence d√©sactiv√©e)`);
    }
    
    if (soundEnabled) {
        log(`   ‚úÖ Son: JOU√â (pr√©f√©rence activ√©e)`);
        // Jouer un son de test si possible
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
            audio.volume = 0.3;
            audio.play().catch(e => log(`   ‚ö†Ô∏è Son: Impossible de jouer (${e.message})`));
        } catch (e) {
            log(`   ‚ö†Ô∏è Son: Impossible de jouer (${e.message})`);
        }
    } else {
        log(`   ‚ùå Son: NON JOU√â (pr√©f√©rence d√©sactiv√©e)`);
    }
    
    if (desktopEnabled) {
        log(`   ‚úÖ Desktop: AFFICH√â (pr√©f√©rence activ√©e)`);
        // Simuler une notification desktop
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                new Notification('Test Notification', {
                    body: 'Ceci est un test de notification',
                    icon: '/favicon.ico'
                });
            } else {
                log(`   ‚ö†Ô∏è Desktop: Permission non accord√©e`);
            }
        } else {
            log(`   ‚ö†Ô∏è Desktop: Notifications non support√©es`);
        }
    } else {
        log(`   ‚ùå Desktop: NON AFFICH√â (pr√©f√©rence d√©sactiv√©e)`);
    }
}

// Tests
function testNotificationWithEmail() {
    log('üß™ TEST 1: Notification avec email activ√©');
    showResult('test1-result', 'Test en cours...', 'info');
    
    setTimeout(() => {
        simulateNotification(true, true, true);
        showResult('test1-result', '‚úÖ Test termin√© - V√©rifiez le log', 'success');
    }, 500);
}

function testNotificationWithoutEmail() {
    log('üß™ TEST 2: Notification avec email d√©sactiv√©');
    showResult('test2-result', 'Test en cours...', 'info');
    
    setTimeout(() => {
        simulateNotification(false, true, true);
        showResult('test2-result', '‚úÖ Test termin√© - V√©rifiez le log', 'success');
    }, 500);
}

function testNotificationWithSound() {
    log('üß™ TEST 3: Notification avec son activ√©');
    showResult('test3-result', 'Test en cours...', 'info');
    
    setTimeout(() => {
        simulateNotification(true, true, true);
        showResult('test3-result', '‚úÖ Test termin√© - V√©rifiez le log', 'success');
    }, 500);
}

function testNotificationWithoutSound() {
    log('üß™ TEST 4: Notification avec son d√©sactiv√©');
    showResult('test4-result', 'Test en cours...', 'info');
    
    setTimeout(() => {
        simulateNotification(true, false, true);
        showResult('test4-result', '‚úÖ Test termin√© - V√©rifiez le log', 'success');
    }, 500);
}

// Gestion du formulaire de pr√©f√©rences
const notificationsForm = document.getElementById('notifications-form');
const notificationsSaveBtn = document.getElementById('notifications-save-btn');

if (notificationsForm && notificationsSaveBtn) {
    notificationsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        log('üíæ Sauvegarde des pr√©f√©rences...');
        
        // Animation du bouton
        const originalText = notificationsSaveBtn.innerHTML;
        notificationsSaveBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Sauvegarde...';
        notificationsSaveBtn.disabled = true;
        
        // R√©cup√©rer les donn√©es du formulaire
        const formData = new FormData(notificationsForm);
        
        // Debug: Afficher les donn√©es envoy√©es
        log('Donn√©es du formulaire:');
        for (let [key, value] of formData.entries()) {
            log(`   ${key}: ${value}`);
        }
        
        // Envoi AJAX
        fetch('/settings/update-notifications', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            log(`üì• R√©ponse re√ßue: ${response.status}`);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            log(`‚úÖ Donn√©es JSON re√ßues: ${JSON.stringify(data)}`);
            
            if (data.success) {
                // Succ√®s
                notificationsSaveBtn.innerHTML = '<i class="bx bx-check"></i> Sauvegard√© !';
                notificationsSaveBtn.style.background = '#22c55e';
                
                log('‚úÖ Pr√©f√©rences sauvegard√©es avec succ√®s');
                
                // Restaurer le bouton apr√®s 2 secondes
                setTimeout(() => {
                    notificationsSaveBtn.innerHTML = originalText;
                    notificationsSaveBtn.style.background = '#2563eb';
                    notificationsSaveBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.message || 'Erreur lors de la sauvegarde');
            }
        })
        .catch(error => {
            log(`‚ùå Erreur: ${error.message}`);
            
            // Erreur
            notificationsSaveBtn.innerHTML = '<i class="bx bx-x"></i> Erreur';
            notificationsSaveBtn.style.background = '#ef4444';
            
            // Restaurer le bouton apr√®s 3 secondes
            setTimeout(() => {
                notificationsSaveBtn.innerHTML = originalText;
                notificationsSaveBtn.style.background = '#2563eb';
                notificationsSaveBtn.disabled = false;
            }, 3000);
        });
    });
}

// Demander la permission pour les notifications desktop
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
        log(`üîî Permission notifications: ${permission}`);
    });
}

// Initialisation
log('üöÄ Test d\'int√©gration des notifications initialis√©');
log('üìã Configurez vos pr√©f√©rences et testez les diff√©rents sc√©narios');
</script>

</body>
</html>

