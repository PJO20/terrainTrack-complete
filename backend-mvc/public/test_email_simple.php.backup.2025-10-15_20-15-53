<?php
/**
 * Script simple pour tester l'envoi d'email
 * Accessible directement via l'URL
 */

// D√©marrer la session
session_start();

// Inclure les d√©pendances
require_once __DIR__ . '/../vendor/autoload.php';

try {
    // Cr√©er les services n√©cessaires
    $host = 'localhost';
    $port = '8889';
    $dbname = 'exemple';
    $username = 'root';
    $password = 'root';
    
    $dsn = "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
    
    // Cr√©er les repositories
    $userRepository = new \App\Repository\UserRepository($pdo);
    $notificationLogsRepository = new \App\Repository\NotificationLogsRepository($pdo);
    $preferencesRepository = new \App\Repository\NotificationPreferencesRepository($pdo);
    
    // Cr√©er le service email
    $emailService = new \App\Service\EmailNotificationService($userRepository, $notificationLogsRepository, $preferencesRepository);
    
    // R√©cup√©rer l'utilisateur (ID 7 = momo@gmail.com)
    $userId = 7;
    $user = $userRepository->findById($userId);
    $preferences = $preferencesRepository->findByUserId($userId);
    
    if (!$user || !$preferences) {
        throw new Exception("Utilisateur ou pr√©f√©rences non trouv√©s");
    }
    
    // Envoyer l'email de test directement avec PHPMailer
    $mail = new \PHPMailer\PHPMailer\PHPMailer(true);
    
    try {
        // Configuration SMTP
        $mail->isSMTP();
        $mail->Host = 'smtp.gmail.com';
        $mail->SMTPAuth = true;
        $mail->Username = 'pjorsini20@gmail.com';
        $mail->Password = 'gmqncgtfunpfnkjh';
        $mail->SMTPSecure = \PHPMailer\PHPMailer\PHPMailer::ENCRYPTION_STARTTLS;
        $mail->Port = 587;
        
        // Configuration de l'email
        $mail->setFrom('pjorsini20@gmail.com', 'TerrainTrack');
        $mail->addAddress('pjorsini20@gmail.com', 'Pierre Jorsini');
        $mail->isHTML(true);
        $mail->Subject = 'Test Email TerrainTrack - ' . date('Y-m-d H:i:s');
        $mail->Body = '
        <h2>üß™ Test Email TerrainTrack</h2>
        <p><strong>Date:</strong> ' . date('Y-m-d H:i:s') . '</p>
        <p><strong>Utilisateur:</strong> ' . $user->getName() . ' (' . $user->getEmail() . ')</p>
        <p><strong>Pr√©f√©rences activ√©es:</strong></p>
        <ul>
            <li>Rappels d\'entretien: ' . (isset($preferences['maintenance_reminders']) && $preferences['maintenance_reminders'] ? 'Oui' : 'Non') . '</li>
            <li>Alertes critiques: ' . (isset($preferences['critical_alerts']) && $preferences['critical_alerts'] ? 'Oui' : 'Non') . '</li>
            <li>Notifications d\'assignation: ' . (isset($preferences['assignment_notifications']) && $preferences['assignment_notifications'] ? 'Oui' : 'Non') . '</li>
        </ul>
        <p>Si vous recevez cet email, le syst√®me de notifications fonctionne correctement !</p>
        <hr>
        <p><em>Email envoy√© par le syst√®me TerrainTrack</em></p>
        ';
        
        $success = $mail->send();
        
        if ($success) {
            echo "‚úÖ Email de test envoy√© avec succ√®s √† pjorsini20@gmail.com !";
            echo "<br><br>";
            echo "üìß V√©rifiez votre bo√Æte email (et le dossier SPAM)";
            echo "<br><br>";
            echo "<a href='/notifications/preferences'>‚Üê Retour aux pr√©f√©rences</a>";
        } else {
            echo "‚ùå √âchec de l'envoi de l'email de test";
            echo "<br><br>";
            echo "<a href='/notifications/preferences'>‚Üê Retour aux pr√©f√©rences</a>";
        }
        
    } catch (\PHPMailer\PHPMailer\Exception $e) {
        echo "‚ùå Erreur PHPMailer: " . $e->getMessage();
        echo "<br><br>";
        echo "<a href='/notifications/preferences'>‚Üê Retour aux pr√©f√©rences</a>";
    }
    
} catch (Exception $e) {
    echo "‚ùå Erreur: " . $e->getMessage();
    echo "<br><br>";
    echo "<a href='/notifications/preferences'>‚Üê Retour aux pr√©f√©rences</a>";
}
?>

