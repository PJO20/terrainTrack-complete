<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Persistance Sons</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #000; }
        .save-btn { background: #2563eb; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .save-btn:hover { background: #1d4ed8; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ''; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .notification-option { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }
        .notification-info { display: flex; align-items: center; gap: 0.75rem; }
        .notification-label { font-weight: 500; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .test-result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .current-state { padding: 15px; background: #e3f2fd; border-radius: 6px; margin: 10px 0; }
    </style>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
<div class='container'>
    <h1>üîä Test Persistance Sons</h1>
    
    <div class='status info'>
        <strong>üéØ Test de persistance des sons de notification</strong><br>
        Ce test v√©rifie que les param√®tres de sons sont correctement sauvegard√©s et persistent apr√®s actualisation de la page.
    </div>
    
    <!-- √âtat actuel -->
    <div class="test-section">
        <h2>üìã √âtat Actuel</h2>
        <div id="current-state" class="current-state">
            <div><strong>üîä Sons de notification:</strong> <span id="current-sound-state">Chargement...</span></div>
            <div><strong>üìß Email notifications:</strong> <span id="current-email-state">Chargement...</span></div>
            <div><strong>üñ•Ô∏è Desktop notifications:</strong> <span id="current-desktop-state">Chargement...</span></div>
            <div><strong>üì± Push notifications:</strong> <span id="current-push-state">Chargement...</span></div>
        </div>
        <button class="btn" onclick="loadCurrentState()">üîÑ Recharger l'√©tat actuel</button>
    </div>
    
    <!-- Configuration des pr√©f√©rences -->
    <div class="test-section">
        <h2>‚öôÔ∏è Configuration</h2>
        <form id="notifications-form">
            <div class="notification-group">
                <div class="notification-options">
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-volume-full'></i>
                            <span class="notification-label">Sons de notification</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sound_notifications" id="sound-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-envelope'></i>
                            <span class="notification-label">Notifications par email</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="email_notifications" id="email-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-desktop'></i>
                            <span class="notification-label">Notifications bureau</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="desktop_notifications" id="desktop-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-mobile'></i>
                            <span class="notification-label">Notifications push</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="push_notifications" id="push-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="save-btn" id="notifications-save-btn">
                <i class='bx bx-save'></i>
                Sauvegarder les pr√©f√©rences
            </button>
        </form>
    </div>
    
    <!-- Tests de persistance -->
    <div class="test-section">
        <h2>üß™ Tests de Persistance</h2>
        
        <div class="test-result">
            <h3>Test 1: D√©sactiver les sons</h3>
            <button class="btn btn-warning" onclick="testDisableSounds()">
                üîá D√©sactiver sons et sauvegarder
            </button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 2: Activer les sons</h3>
            <button class="btn btn-success" onclick="testEnableSounds()">
                üîä Activer sons et sauvegarder
            </button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 3: Simuler actualisation</h3>
            <button class="btn" onclick="testPageRefresh()">
                üîÑ Simuler actualisation de page
            </button>
            <div id="test3-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 4: Actualisation r√©elle</h3>
            <button class="btn btn-danger" onclick="testRealRefresh()">
                ‚ö†Ô∏è Actualiser la page (R√âEL)
            </button>
            <div id="test4-result"></div>
        </div>
    </div>
    
    <!-- Log des tests -->
    <div class="test-section">
        <h2>üìù Log des Tests</h2>
        <div id="test-log" class="log"></div>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Effacer le log</button>
    </div>
    
    <div class='status info'>
        <strong>üîß Instructions:</strong><br>
        1. V√©rifiez l'√©tat actuel des param√®tres<br>
        2. Testez la d√©sactivation des sons<br>
        3. Testez l'activation des sons<br>
        4. Simulez une actualisation de page<br>
        5. Effectuez une actualisation r√©elle pour v√©rifier la persistance
    </div>
</div>

<script>
// Log des tests
function log(message, type = 'info') {
    const logDiv = document.getElementById('test-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}\n`;
    logDiv.innerHTML += logEntry;
    logDiv.scrollTop = logDiv.scrollHeight;
    
    console.log(`üîä ${message}`);
}

function clearLog() {
    document.getElementById('test-log').innerHTML = '';
}

// Fonction pour afficher les r√©sultats
function showResult(testId, message, type = 'info') {
    const resultDiv = document.getElementById(testId);
    resultDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
}

// Charger l'√©tat actuel depuis le serveur
function loadCurrentState() {
    log('üì• Chargement de l\'√©tat actuel...');
    
    fetch('/settings/get-notifications', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.notifications) {
            const notifications = data.notifications;
            
            // Mettre √† jour l'affichage de l'√©tat actuel
            document.getElementById('current-sound-state').textContent = notifications.sound_notifications ? 'ACTIV√â' : 'D√âSACTIV√â';
            document.getElementById('current-email-state').textContent = notifications.email_notifications ? 'ACTIV√â' : 'D√âSACTIV√â';
            document.getElementById('current-desktop-state').textContent = notifications.desktop_notifications ? 'ACTIV√â' : 'D√âSACTIV√â';
            document.getElementById('current-push-state').textContent = notifications.push_notifications ? 'ACTIV√â' : 'D√âSACTIV√â';
            
            // Mettre √† jour les toggles
            document.getElementById('sound-toggle').checked = notifications.sound_notifications;
            document.getElementById('email-toggle').checked = notifications.email_notifications;
            document.getElementById('desktop-toggle').checked = notifications.desktop_notifications;
            document.getElementById('push-toggle').checked = notifications.push_notifications;
            
            log('‚úÖ √âtat actuel charg√© avec succ√®s');
            log(`   üîä Sons: ${notifications.sound_notifications ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
            log(`   üìß Email: ${notifications.email_notifications ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
            log(`   üñ•Ô∏è Desktop: ${notifications.desktop_notifications ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
            log(`   üì± Push: ${notifications.push_notifications ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
        } else {
            log('‚ùå Erreur lors du chargement de l\'√©tat actuel');
        }
    })
    .catch(error => {
        log(`‚ùå Erreur de chargement: ${error.message}`);
        
        // Fallback: essayer de r√©cup√©rer depuis la page settings
        log('üîÑ Tentative de r√©cup√©ration alternative...');
        
        // Simuler les valeurs par d√©faut
        document.getElementById('current-sound-state').textContent = 'INCONNU';
        document.getElementById('current-email-state').textContent = 'INCONNU';
        document.getElementById('current-desktop-state').textContent = 'INCONNU';
        document.getElementById('current-push-state').textContent = 'INCONNU';
    });
}

// Test de d√©sactivation des sons
function testDisableSounds() {
    log('üß™ TEST 1: D√©sactivation des sons');
    
    // D√©sactiver le toggle
    document.getElementById('sound-toggle').checked = false;
    
    // Sauvegarder
    saveNotifications().then(success => {
        if (success) {
            showResult('test1-result', '‚úÖ Sons d√©sactiv√©s et sauvegard√©s', 'success');
            log('‚úÖ Test 1 r√©ussi: Sons d√©sactiv√©s');
            
            // Recharger l'√©tat pour v√©rifier
            setTimeout(() => {
                loadCurrentState();
            }, 500);
        } else {
            showResult('test1-result', '‚ùå Erreur lors de la d√©sactivation', 'error');
            log('‚ùå Test 1 √©chou√©: Erreur de sauvegarde');
        }
    });
}

// Test d'activation des sons
function testEnableSounds() {
    log('üß™ TEST 2: Activation des sons');
    
    // Activer le toggle
    document.getElementById('sound-toggle').checked = true;
    
    // Sauvegarder
    saveNotifications().then(success => {
        if (success) {
            showResult('test2-result', '‚úÖ Sons activ√©s et sauvegard√©s', 'success');
            log('‚úÖ Test 2 r√©ussi: Sons activ√©s');
            
            // Recharger l'√©tat pour v√©rifier
            setTimeout(() => {
                loadCurrentState();
            }, 500);
        } else {
            showResult('test2-result', '‚ùå Erreur lors de l\'activation', 'error');
            log('‚ùå Test 2 √©chou√©: Erreur de sauvegarde');
        }
    });
}

// Test de simulation d'actualisation
function testPageRefresh() {
    log('üß™ TEST 3: Simulation d\'actualisation');
    
    // Sauvegarder l'√©tat actuel
    const currentSoundState = document.getElementById('sound-toggle').checked;
    
    // Simuler un rechargement en rechargeant les donn√©es
    loadCurrentState();
    
    setTimeout(() => {
        const newSoundState = document.getElementById('sound-toggle').checked;
        
        if (currentSoundState === newSoundState) {
            showResult('test3-result', '‚úÖ √âtat conserv√© apr√®s simulation', 'success');
            log('‚úÖ Test 3 r√©ussi: √âtat conserv√©');
        } else {
            showResult('test3-result', '‚ùå √âtat perdu apr√®s simulation', 'error');
            log('‚ùå Test 3 √©chou√©: √âtat non conserv√©');
        }
    }, 1000);
}

// Test d'actualisation r√©elle
function testRealRefresh() {
    log('üß™ TEST 4: Actualisation r√©elle de la page');
    
    // Sauvegarder l'√©tat dans localStorage pour v√©rification apr√®s actualisation
    const currentState = {
        sound: document.getElementById('sound-toggle').checked,
        email: document.getElementById('email-toggle').checked,
        desktop: document.getElementById('desktop-toggle').checked,
        push: document.getElementById('push-toggle').checked
    };
    
    localStorage.setItem('test_state_before_refresh', JSON.stringify(currentState));
    
    showResult('test4-result', '‚ö†Ô∏è Actualisation de la page dans 2 secondes...', 'warning');
    
    setTimeout(() => {
        window.location.reload();
    }, 2000);
}

// Fonction pour sauvegarder les notifications
function saveNotifications() {
    return new Promise((resolve) => {
        const formData = new FormData(document.getElementById('notifications-form'));
        
        // Ajouter les champs non coch√©s
        const checkboxes = ['sound_notifications', 'email_notifications', 'desktop_notifications', 'push_notifications'];
        checkboxes.forEach(name => {
            if (!formData.has(name)) {
                formData.append(name, 'off');
            }
        });
        
        log('üíæ Sauvegarde en cours...');
        
        fetch('/settings/update-notifications', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                log('‚úÖ Sauvegarde r√©ussie');
                resolve(true);
            } else {
                log(`‚ùå Erreur de sauvegarde: ${data.message}`);
                resolve(false);
            }
        })
        .catch(error => {
            log(`‚ùå Erreur de sauvegarde: ${error.message}`);
            resolve(false);
        });
    });
}

// Gestion du formulaire de pr√©f√©rences
const notificationsForm = document.getElementById('notifications-form');
const notificationsSaveBtn = document.getElementById('notifications-save-btn');

if (notificationsForm && notificationsSaveBtn) {
    notificationsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        log('üíæ Sauvegarde manuelle...');
        
        // Animation du bouton
        const originalText = notificationsSaveBtn.innerHTML;
        notificationsSaveBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Sauvegarde...';
        notificationsSaveBtn.disabled = true;
        
        saveNotifications().then(success => {
            if (success) {
                notificationsSaveBtn.innerHTML = '<i class="bx bx-check"></i> Sauvegard√© !';
                notificationsSaveBtn.style.background = '#22c55e';
                
                // Recharger l'√©tat
                setTimeout(() => {
                    loadCurrentState();
                }, 500);
            } else {
                notificationsSaveBtn.innerHTML = '<i class="bx bx-x"></i> Erreur';
                notificationsSaveBtn.style.background = '#ef4444';
            }
            
            // Restaurer le bouton
            setTimeout(() => {
                notificationsSaveBtn.innerHTML = originalText;
                notificationsSaveBtn.style.background = '#2563eb';
                notificationsSaveBtn.disabled = false;
            }, 2000);
        });
    });
}

// V√©rifier s'il y a eu une actualisation
document.addEventListener('DOMContentLoaded', function() {
    log('üöÄ Test de persistance des sons initialis√©');
    
    // Charger l'√©tat actuel
    loadCurrentState();
    
    // V√©rifier s'il y a eu une actualisation
    const testStateBefore = localStorage.getItem('test_state_before_refresh');
    if (testStateBefore) {
        const stateBefore = JSON.parse(testStateBefore);
        localStorage.removeItem('test_state_before_refresh');
        
        log('üîÑ V√©rification apr√®s actualisation...');
        
        setTimeout(() => {
            const currentSoundState = document.getElementById('sound-toggle').checked;
            
            if (stateBefore.sound === currentSoundState) {
                showResult('test4-result', '‚úÖ √âtat conserv√© apr√®s actualisation r√©elle', 'success');
                log('‚úÖ Test 4 r√©ussi: Persistance apr√®s actualisation r√©elle');
            } else {
                showResult('test4-result', '‚ùå √âtat perdu apr√®s actualisation r√©elle', 'error');
                log('‚ùå Test 4 √©chou√©: Persistance √©chou√©e apr√®s actualisation r√©elle');
            }
        }, 1000);
    }
});
</script>

</body>
</html>

