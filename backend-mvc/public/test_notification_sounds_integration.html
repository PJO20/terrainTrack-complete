<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sons de Notification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #000; }
        .save-btn { background: #2563eb; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .save-btn:hover { background: #1d4ed8; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ''; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .notification-option { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }
        .notification-info { display: flex; align-items: center; gap: 0.75rem; }
        .notification-label { font-weight: 500; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .test-result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .sound-test-btn { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
        .sound-test-btn.info { background: #17a2b8; color: white; }
        .sound-test-btn.warning { background: #ffc107; color: #000; }
        .sound-test-btn.success { background: #28a745; color: white; }
        .sound-test-btn.error { background: #dc3545; color: white; }
    </style>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
<div class='container'>
    <h1>üîä Test Sons de Notification</h1>
    
    <div class='status info'>
        <strong>üéØ Test complet des sons de notification</strong><br>
        Ce test v√©rifie que les sons sont jou√©s selon les pr√©f√©rences utilisateur et le type de notification.
    </div>
    
    <!-- Configuration des pr√©f√©rences -->
    <div class="test-section">
        <h2>üìã Configuration des Pr√©f√©rences</h2>
        <form id="notifications-form">
            <div class="notification-group">
                <h3>Canaux de notification</h3>
                <div class="notification-options">
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-volume-full'></i>
                            <span class="notification-label">Sons de notification</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sound_notifications" id="sound-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <h3>Types de notifications</h3>
                <div class="notification-options">
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-car'></i>
                            <span class="notification-label">Alertes v√©hicules</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="vehicle_alerts" id="vehicle-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-calendar'></i>
                            <span class="notification-label">Rappels de maintenance</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="maintenance_reminders" id="maintenance-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-refresh'></i>
                            <span class="notification-label">Mises √† jour interventions</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="intervention_updates" id="intervention-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-group'></i>
                            <span class="notification-label">Notifications √©quipe</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="team_notifications" id="team-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-cog'></i>
                            <span class="notification-label">Alertes syst√®me</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="system_alerts" id="system-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="save-btn" id="notifications-save-btn">
                <i class='bx bx-save'></i>
                Sauvegarder les pr√©f√©rences
            </button>
        </form>
    </div>
    
    <!-- Test des sons par type -->
    <div class="test-section">
        <h2>üß™ Tests de Sons par Type</h2>
        
        <div class="test-result">
            <h3>Test 1: Alerte v√©hicule (Son 'warning')</h3>
            <button class="sound-test-btn warning" onclick="testNotificationSound('vehicle_alert', 'warning')">
                üöó Tester alerte v√©hicule
            </button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 2: Rappel maintenance (Son 'info')</h3>
            <button class="sound-test-btn info" onclick="testNotificationSound('maintenance_reminder', 'info')">
                üìÖ Tester rappel maintenance
            </button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 3: Mise √† jour intervention (Son 'success')</h3>
            <button class="sound-test-btn success" onclick="testNotificationSound('intervention_update', 'success')">
                üîÑ Tester mise √† jour intervention
            </button>
            <div id="test3-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 4: Notification √©quipe (Son 'info')</h3>
            <button class="sound-test-btn info" onclick="testNotificationSound('team_notification', 'info')">
                üë• Tester notification √©quipe
            </button>
            <div id="test4-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 5: Alerte syst√®me (Son 'error')</h3>
            <button class="sound-test-btn error" onclick="testNotificationSound('system_alert', 'error')">
                ‚öôÔ∏è Tester alerte syst√®me
            </button>
            <div id="test5-result"></div>
        </div>
    </div>
    
    <!-- Test global -->
    <div class="test-section">
        <h2>üîÑ Test Global</h2>
        
        <div class="test-result">
            <h3>Test complet avec pr√©f√©rences actuelles</h3>
            <button class="btn" onclick="testAllNotificationSounds()">
                üîî Tester toutes les notifications
            </button>
            <div id="test-global-result"></div>
        </div>
    </div>
    
    <!-- Log des tests -->
    <div class="test-section">
        <h2>üìù Log des Tests</h2>
        <div id="test-log" class="log"></div>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Effacer le log</button>
    </div>
    
    <div class='status info'>
        <strong>üîß Instructions:</strong><br>
        1. Configurez vos pr√©f√©rences ci-dessus<br>
        2. Sauvegardez les pr√©f√©rences<br>
        3. Testez les diff√©rents types de notifications<br>
        4. V√©rifiez que les sons correspondent aux pr√©f√©rences<br>
        5. Consultez le log pour les d√©tails
    </div>
</div>

<script>
// Log des tests
function log(message, type = 'info') {
    const logDiv = document.getElementById('test-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}\n`;
    logDiv.innerHTML += logEntry;
    logDiv.scrollTop = logDiv.scrollHeight;
    
    console.log(`üîä ${message}`);
}

function clearLog() {
    document.getElementById('test-log').innerHTML = '';
}

// Fonction pour afficher les r√©sultats
function showResult(testId, message, type = 'info') {
    const resultDiv = document.getElementById(testId);
    resultDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
}

// Fonction pour jouer un son selon le type
function playSound(soundType) {
    // Cr√©er un son simple selon le type
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Fr√©quences diff√©rentes selon le type
    const frequencies = {
        'info': 800,
        'warning': 600,
        'success': 1000,
        'error': 400
    };
    
    oscillator.frequency.setValueAtTime(frequencies[soundType] || 800, audioContext.currentTime);
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
    
    log(`üéµ Son '${soundType}' jou√© (fr√©quence: ${frequencies[soundType]}Hz)`);
}

// Test de notification avec son selon le type
function testNotificationSound(notificationType, soundType) {
    log(`üß™ TEST: ${notificationType} (son: ${soundType})`);
    
    const soundEnabled = document.getElementById('sound-toggle').checked;
    let typeEnabled = false;
    
    // V√©rifier si le type de notification est activ√©
    switch (notificationType) {
        case 'vehicle_alert':
            typeEnabled = document.getElementById('vehicle-toggle').checked;
            break;
        case 'maintenance_reminder':
            typeEnabled = document.getElementById('maintenance-toggle').checked;
            break;
        case 'intervention_update':
            typeEnabled = document.getElementById('intervention-toggle').checked;
            break;
        case 'team_notification':
            typeEnabled = document.getElementById('team-toggle').checked;
            break;
        case 'system_alert':
            typeEnabled = document.getElementById('system-toggle').checked;
            break;
    }
    
    log(`üìã Configuration: Sons=${soundEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}, Type=${typeEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    
    if (soundEnabled && typeEnabled) {
        playSound(soundType);
        log(`‚úÖ Son '${soundType}' jou√© (sons activ√©s + type activ√©)`);
        
        const testNumber = notificationType === 'vehicle_alert' ? '1' : 
                          notificationType === 'maintenance_reminder' ? '2' : 
                          notificationType === 'intervention_update' ? '3' : 
                          notificationType === 'team_notification' ? '4' : '5';
        showResult(`test${testNumber}-result`, `‚úÖ Son '${soundType}' jou√©`, 'success');
    } else if (!soundEnabled) {
        log(`‚ùå Aucun son jou√© (sons d√©sactiv√©s)`);
        
        const testNumber = notificationType === 'vehicle_alert' ? '1' : 
                          notificationType === 'maintenance_reminder' ? '2' : 
                          notificationType === 'intervention_update' ? '3' : 
                          notificationType === 'team_notification' ? '4' : '5';
        showResult(`test${testNumber}-result`, `‚ùå Aucun son (sons d√©sactiv√©s)`, 'warning');
    } else if (!typeEnabled) {
        log(`‚ùå Aucun son jou√© (type de notification d√©sactiv√©)`);
        
        const testNumber = notificationType === 'vehicle_alert' ? '1' : 
                          notificationType === 'maintenance_reminder' ? '2' : 
                          notificationType === 'intervention_update' ? '3' : 
                          notificationType === 'team_notification' ? '4' : '5';
        showResult(`test${testNumber}-result`, `‚ùå Aucun son (type d√©sactiv√©)`, 'warning');
    }
}

// Test de toutes les notifications
function testAllNotificationSounds() {
    log('üß™ TEST GLOBAL: Toutes les notifications');
    
    const soundEnabled = document.getElementById('sound-toggle').checked;
    log(`üîä Sons de notification: ${soundEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    
    const notifications = [
        { type: 'vehicle_alert', sound: 'warning', name: 'Alerte v√©hicule' },
        { type: 'maintenance_reminder', sound: 'info', name: 'Rappel maintenance' },
        { type: 'intervention_update', sound: 'success', name: 'Mise √† jour intervention' },
        { type: 'team_notification', sound: 'info', name: 'Notification √©quipe' },
        { type: 'system_alert', sound: 'error', name: 'Alerte syst√®me' }
    ];
    
    let delay = 0;
    notifications.forEach((notif, index) => {
        setTimeout(() => {
            testNotificationSound(notif.type, notif.sound);
        }, delay);
        delay += 1000; // 1 seconde entre chaque test
    });
    
    showResult('test-global-result', '‚úÖ Test global termin√© - V√©rifiez le log', 'success');
}

// Gestion du formulaire de pr√©f√©rences
const notificationsForm = document.getElementById('notifications-form');
const notificationsSaveBtn = document.getElementById('notifications-save-btn');

if (notificationsForm && notificationsSaveBtn) {
    notificationsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        log('üíæ Sauvegarde des pr√©f√©rences...');
        
        // Animation du bouton
        const originalText = notificationsSaveBtn.innerHTML;
        notificationsSaveBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Sauvegarde...';
        notificationsSaveBtn.disabled = true;
        
        // R√©cup√©rer les donn√©es du formulaire
        const formData = new FormData(notificationsForm);
        
        // Debug: Afficher les donn√©es envoy√©es
        log('Donn√©es du formulaire:');
        for (let [key, value] of formData.entries()) {
            log(`   ${key}: ${value}`);
        }
        
        // Envoi AJAX
        fetch('/settings/update-notifications', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            log(`üì• R√©ponse re√ßue: ${response.status}`);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            log(`‚úÖ Donn√©es JSON re√ßues: ${JSON.stringify(data)}`);
            
            if (data.success) {
                // Succ√®s
                notificationsSaveBtn.innerHTML = '<i class="bx bx-check"></i> Sauvegard√© !';
                notificationsSaveBtn.style.background = '#22c55e';
                
                log('‚úÖ Pr√©f√©rences sauvegard√©es avec succ√®s');
                
                // Restaurer le bouton apr√®s 2 secondes
                setTimeout(() => {
                    notificationsSaveBtn.innerHTML = originalText;
                    notificationsSaveBtn.style.background = '#2563eb';
                    notificationsSaveBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.message || 'Erreur lors de la sauvegarde');
            }
        })
        .catch(error => {
            log(`‚ùå Erreur: ${error.message}`);
            
            // Erreur
            notificationsSaveBtn.innerHTML = '<i class="bx bx-x"></i> Erreur';
            notificationsSaveBtn.style.background = '#ef4444';
            
            // Restaurer le bouton apr√®s 3 secondes
            setTimeout(() => {
                notificationsSaveBtn.innerHTML = originalText;
                notificationsSaveBtn.style.background = '#2563eb';
                notificationsSaveBtn.disabled = false;
            }, 3000);
        });
    });
}

// Initialisation
log('üöÄ Test des sons de notification initialis√©');
log('üìã Configurez vos pr√©f√©rences et testez les diff√©rents types de sons');
log('üéµ Mapping des sons: vehicle_alert‚Üíwarning, maintenance_reminder‚Üíinfo, intervention_update‚Üísuccess, team_notification‚Üíinfo, system_alert‚Üíerror');
</script>

</body>
</html>
