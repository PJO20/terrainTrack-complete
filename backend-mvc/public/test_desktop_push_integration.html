<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Int√©gration Desktop & Push</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #000; }
        .save-btn { background: #2563eb; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .save-btn:hover { background: #1d4ed8; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ''; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .notification-option { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }
        .notification-info { display: flex; align-items: center; gap: 0.75rem; }
        .notification-label { font-weight: 500; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .test-result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .permission-status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .permission-granted { background: #d4edda; color: #155724; }
        .permission-denied { background: #f8d7da; color: #721c24; }
        .permission-default { background: #fff3cd; color: #856404; }
    </style>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
<div class='container'>
    <h1>üñ•Ô∏è Test Int√©gration Desktop & Push</h1>
    
    <div class='status info'>
        <strong>üéØ Test complet des notifications bureau et push</strong><br>
        Ce test v√©rifie que les notifications bureau et push respectent les pr√©f√©rences utilisateur.
    </div>
    
    <!-- V√©rification des permissions -->
    <div class="test-section">
        <h2>üîê V√©rification des Permissions</h2>
        <div id="permission-status" class="permission-status">
            <strong>√âtat des permissions :</strong>
            <div id="notification-permission"></div>
            <div id="push-permission"></div>
        </div>
        <button class="btn" onclick="requestPermissions()">üîê Demander les permissions</button>
    </div>
    
    <!-- Configuration des pr√©f√©rences -->
    <div class="test-section">
        <h2>üìã Configuration des Pr√©f√©rences</h2>
        <form id="notifications-form">
            <div class="notification-group">
                <h3>Canaux de notification</h3>
                <div class="notification-options">
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-desktop'></i>
                            <span class="notification-label">Notifications bureau</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="desktop_notifications" id="desktop-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-mobile'></i>
                            <span class="notification-label">Notifications push</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="push_notifications" id="push-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-envelope'></i>
                            <span class="notification-label">Notifications par email</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="email_notifications" id="email-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-option">
                        <div class="notification-info">
                            <i class='bx bx-volume-full'></i>
                            <span class="notification-label">Sons de notification</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sound_notifications" id="sound-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="save-btn" id="notifications-save-btn">
                <i class='bx bx-save'></i>
                Sauvegarder les pr√©f√©rences
            </button>
        </form>
    </div>
    
    <!-- Test des notifications -->
    <div class="test-section">
        <h2>üß™ Tests de Notification</h2>
        
        <div class="test-result">
            <h3>Test 1: Notification bureau activ√©e</h3>
            <button class="btn btn-success" onclick="testDesktopNotification(true)">
                üñ•Ô∏è Tester avec bureau activ√©
            </button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 2: Notification bureau d√©sactiv√©e</h3>
            <button class="btn btn-warning" onclick="testDesktopNotification(false)">
                üñ•Ô∏è Tester avec bureau d√©sactiv√©
            </button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 3: Notification push activ√©e</h3>
            <button class="btn btn-success" onclick="testPushNotification(true)">
                üì± Tester avec push activ√©
            </button>
            <div id="test3-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 4: Notification push d√©sactiv√©e</h3>
            <button class="btn btn-warning" onclick="testPushNotification(false)">
                üì± Tester avec push d√©sactiv√©
            </button>
            <div id="test4-result"></div>
        </div>
        
        <div class="test-result">
            <h3>Test 5: Notification compl√®te</h3>
            <button class="btn" onclick="testCompleteNotification()">
                üîî Tester notification compl√®te
            </button>
            <div id="test5-result"></div>
        </div>
    </div>
    
    <!-- Log des tests -->
    <div class="test-section">
        <h2>üìù Log des Tests</h2>
        <div id="test-log" class="log"></div>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Effacer le log</button>
    </div>
    
    <div class='status info'>
        <strong>üîß Instructions:</strong><br>
        1. V√©rifiez les permissions ci-dessus<br>
        2. Configurez vos pr√©f√©rences<br>
        3. Sauvegardez les pr√©f√©rences<br>
        4. Testez les diff√©rents sc√©narios<br>
        5. V√©rifiez les r√©sultats dans le log
    </div>
</div>

<script>
// Log des tests
function log(message, type = 'info') {
    const logDiv = document.getElementById('test-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}\n`;
    logDiv.innerHTML += logEntry;
    logDiv.scrollTop = logDiv.scrollHeight;
    
    console.log(`üîî ${message}`);
}

function clearLog() {
    document.getElementById('test-log').innerHTML = '';
}

// Fonction pour afficher les r√©sultats
function showResult(testId, message, type = 'info') {
    const resultDiv = document.getElementById(testId);
    resultDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
}

// V√©rifier les permissions
function checkPermissions() {
    const notificationPermission = document.getElementById('notification-permission');
    const pushPermission = document.getElementById('push-permission');
    
    // Permissions notifications
    if ('Notification' in window) {
        const permission = Notification.permission;
        notificationPermission.innerHTML = `Notifications: <strong>${permission}</strong>`;
        
        if (permission === 'granted') {
            notificationPermission.className = 'permission-granted';
        } else if (permission === 'denied') {
            notificationPermission.className = 'permission-denied';
        } else {
            notificationPermission.className = 'permission-default';
        }
    } else {
        notificationPermission.innerHTML = 'Notifications: <strong>Non support√©es</strong>';
        notificationPermission.className = 'permission-denied';
    }
    
    // Permissions push (simulation)
    if ('serviceWorker' in navigator) {
        pushPermission.innerHTML = 'Push: <strong>Support√©</strong>';
        pushPermission.className = 'permission-granted';
    } else {
        pushPermission.innerHTML = 'Push: <strong>Non support√©</strong>';
        pushPermission.className = 'permission-denied';
    }
}

// Demander les permissions
function requestPermissions() {
    log('üîê Demande des permissions...');
    
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            log(`üîî Permission notifications: ${permission}`);
            checkPermissions();
        });
    } else {
        log('‚ùå Notifications non support√©es par ce navigateur');
    }
}

// Test de notification bureau
function testDesktopNotification(enabled) {
    log(`üß™ TEST: Notification bureau ${enabled ? 'activ√©e' : 'd√©sactiv√©e'}`);
    
    if (enabled) {
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification('Test Notification Bureau', {
                body: 'Ceci est un test de notification bureau',
                icon: '/favicon.ico',
                tag: 'test-notification'
            });
            
            notification.onclick = function() {
                log('üñ•Ô∏è Notification bureau cliqu√©e');
                window.focus();
            };
            
            log('‚úÖ Notification bureau affich√©e');
            showResult('test1-result', '‚úÖ Notification bureau affich√©e', 'success');
        } else {
            log('‚ùå Permission notifications non accord√©e');
            showResult('test1-result', '‚ùå Permission non accord√©e', 'error');
        }
    } else {
        log('‚ùå Notification bureau d√©sactiv√©e - Aucune notification affich√©e');
        showResult('test1-result', '‚ùå Notification bureau d√©sactiv√©e', 'warning');
    }
}

// Test de notification push
function testPushNotification(enabled) {
    log(`üß™ TEST: Notification push ${enabled ? 'activ√©e' : 'd√©sactiv√©e'}`);
    
    if (enabled) {
        if ('serviceWorker' in navigator) {
            // Simuler une notification push
            log('üì± Simulation d\'une notification push');
            log('‚úÖ Notification push envoy√©e (simulation)');
            showResult('test3-result', '‚úÖ Notification push envoy√©e', 'success');
        } else {
            log('‚ùå Service Worker non support√©');
            showResult('test3-result', '‚ùå Service Worker non support√©', 'error');
        }
    } else {
        log('‚ùå Notification push d√©sactiv√©e - Aucune notification push envoy√©e');
        showResult('test3-result', '‚ùå Notification push d√©sactiv√©e', 'warning');
    }
}

// Test de notification compl√®te
function testCompleteNotification() {
    log('üß™ TEST: Notification compl√®te');
    
    const desktopEnabled = document.getElementById('desktop-toggle').checked;
    const pushEnabled = document.getElementById('push-toggle').checked;
    const emailEnabled = document.getElementById('email-toggle').checked;
    const soundEnabled = document.getElementById('sound-toggle').checked;
    
    log(`üì§ Configuration actuelle:`);
    log(`   üñ•Ô∏è Desktop: ${desktopEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    log(`   üì± Push: ${pushEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    log(`   üìß Email: ${emailEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    log(`   üîä Son: ${soundEnabled ? 'ACTIV√â' : 'D√âSACTIV√â'}`);
    
    // Simuler l'envoi selon les pr√©f√©rences
    if (desktopEnabled) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Test Complet', {
                body: 'Notification bureau selon les pr√©f√©rences',
                icon: '/favicon.ico'
            });
            log('‚úÖ Desktop: Notification affich√©e');
        } else {
            log('‚ùå Desktop: Permission non accord√©e');
        }
    } else {
        log('‚ùå Desktop: D√©sactiv√© - Pas de notification');
    }
    
    if (pushEnabled) {
        log('‚úÖ Push: Notification push envoy√©e (simulation)');
    } else {
        log('‚ùå Push: D√©sactiv√© - Pas de notification push');
    }
    
    if (emailEnabled) {
        log('‚úÖ Email: Email envoy√© (simulation)');
    } else {
        log('‚ùå Email: D√©sactiv√© - Pas d\'email');
    }
    
    if (soundEnabled) {
        log('‚úÖ Son: Son jou√© (simulation)');
    } else {
        log('‚ùå Son: D√©sactiv√© - Pas de son');
    }
    
    showResult('test5-result', '‚úÖ Test complet termin√© - V√©rifiez le log', 'success');
}

// Gestion du formulaire de pr√©f√©rences
const notificationsForm = document.getElementById('notifications-form');
const notificationsSaveBtn = document.getElementById('notifications-save-btn');

if (notificationsForm && notificationsSaveBtn) {
    notificationsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        log('üíæ Sauvegarde des pr√©f√©rences...');
        
        // Animation du bouton
        const originalText = notificationsSaveBtn.innerHTML;
        notificationsSaveBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Sauvegarde...';
        notificationsSaveBtn.disabled = true;
        
        // R√©cup√©rer les donn√©es du formulaire
        const formData = new FormData(notificationsForm);
        
        // Debug: Afficher les donn√©es envoy√©es
        log('Donn√©es du formulaire:');
        for (let [key, value] of formData.entries()) {
            log(`   ${key}: ${value}`);
        }
        
        // Envoi AJAX
        fetch('/settings/update-notifications', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            log(`üì• R√©ponse re√ßue: ${response.status}`);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            log(`‚úÖ Donn√©es JSON re√ßues: ${JSON.stringify(data)}`);
            
            if (data.success) {
                // Succ√®s
                notificationsSaveBtn.innerHTML = '<i class="bx bx-check"></i> Sauvegard√© !';
                notificationsSaveBtn.style.background = '#22c55e';
                
                log('‚úÖ Pr√©f√©rences sauvegard√©es avec succ√®s');
                
                // Restaurer le bouton apr√®s 2 secondes
                setTimeout(() => {
                    notificationsSaveBtn.innerHTML = originalText;
                    notificationsSaveBtn.style.background = '#2563eb';
                    notificationsSaveBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.message || 'Erreur lors de la sauvegarde');
            }
        })
        .catch(error => {
            log(`‚ùå Erreur: ${error.message}`);
            
            // Erreur
            notificationsSaveBtn.innerHTML = '<i class="bx bx-x"></i> Erreur';
            notificationsSaveBtn.style.background = '#ef4444';
            
            // Restaurer le bouton apr√®s 3 secondes
            setTimeout(() => {
                notificationsSaveBtn.innerHTML = originalText;
                notificationsSaveBtn.style.background = '#2563eb';
                notificationsSaveBtn.disabled = false;
            }, 3000);
        });
    });
}

// Initialisation
log('üöÄ Test d\'int√©gration desktop & push initialis√©');
log('üìã Configurez vos pr√©f√©rences et testez les diff√©rents sc√©narios');

// V√©rifier les permissions au chargement
checkPermissions();
</script>

</body>
</html>

