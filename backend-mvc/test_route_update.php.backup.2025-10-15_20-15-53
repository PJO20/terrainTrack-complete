<?php
/**
 * Test de la route de mise Ã  jour des prÃ©fÃ©rences
 */

echo "ðŸ” Test de la route de mise Ã  jour\n";
echo "================================\n\n";

// Simuler une session utilisateur
session_start();
$_SESSION['user_id'] = 7;
$_SESSION['user_email'] = 'momo@gmail.com';
$_SESSION['user_name'] = 'Momo';
$_SESSION['user_role'] = 'admin';

echo "âœ… Session simulÃ©e pour momo@gmail.com\n";

// Simuler les donnÃ©es POST
$_POST = [
    'notification_email' => 'pjorsini20@gmail.com',
    'email_notifications' => '1',
    'sms_notifications' => '0',
    'intervention_assignments' => '1',
    'maintenance_reminders' => '1',
    'critical_alerts' => '1',
    'reminder_frequency_days' => '7',
    'phone' => '+33 6 12 34 56 78',
    'notification_sms' => '0'
];

$_SERVER['REQUEST_METHOD'] = 'POST';

echo "ðŸ“‹ DonnÃ©es POST simulÃ©es:\n";
foreach ($_POST as $key => $value) {
    echo "  - $key: $value\n";
}

// Inclure les dÃ©pendances
require_once __DIR__ . '/vendor/autoload.php';

try {
    // CrÃ©er les services
    $host = 'localhost';
    $port = '8889';
    $dbname = 'exemple';
    $username = 'root';
    $password = 'root';
    
    $dsn = "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
    
    // CrÃ©er les repositories
    $userRepository = new \App\Repository\UserRepository($pdo);
    $preferencesRepository = new \App\Repository\NotificationPreferencesRepository($pdo);
    
    // CrÃ©er les services
    $sessionManager = new \App\Service\SessionManager();
    $emailService = new \App\Service\EmailNotificationService($userRepository, new \App\Repository\NotificationLogsRepository($pdo));
    $smsService = new \App\Service\SmsNotificationService($userRepository, new \App\Repository\NotificationLogsRepository($pdo));
    $permissionService = new \App\Service\PermissionService($pdo);
    
    // CrÃ©er le service Twig
    $twig = new \App\Service\TwigService($sessionManager, $permissionService);
    
    // CrÃ©er le contrÃ´leur
    $controller = new \App\Controller\NotificationPreferencesController(
        $sessionManager,
        $userRepository,
        $preferencesRepository,
        $emailService,
        $smsService,
        $twig
    );
    
    echo "\nâœ… ContrÃ´leur crÃ©Ã© avec succÃ¨s\n";
    
    // Capturer la sortie pour Ã©viter les redirections
    ob_start();
    
    try {
        $controller->update();
        $output = ob_get_contents();
        echo "âœ… MÃ©thode update() exÃ©cutÃ©e\n";
        echo "ðŸ“¤ Sortie capturÃ©e: " . strlen($output) . " caractÃ¨res\n";
        
        if (strpos($output, 'Location:') !== false) {
            echo "ðŸ”„ Redirection dÃ©tectÃ©e dans la sortie\n";
        }
        
    } catch (Exception $e) {
        echo "âŒ Erreur lors de l'exÃ©cution: " . $e->getMessage() . "\n";
    }
    
    ob_end_clean();
    
} catch (Exception $e) {
    echo "âŒ Erreur: " . $e->getMessage() . "\n";
    echo "ðŸ“ Fichier: " . $e->getFile() . ":" . $e->getLine() . "\n";
}

echo "\nðŸ” Test terminÃ© !\n";
?>
