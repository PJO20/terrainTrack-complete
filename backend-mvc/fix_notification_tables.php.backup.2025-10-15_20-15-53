<?php
/**
 * Script pour corriger les tables de notifications
 * TerrainTrack - Correction des tables
 */

echo "ğŸ”§ Correction des tables de notifications\n";
echo "========================================\n\n";

// Configuration de la base de donnÃ©es
$host = 'localhost';
$port = '8889';
$dbname = 'exemple';
$username = 'root';
$password = 'root';

try {
    // Connexion Ã  la base de donnÃ©es
    $dsn = "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
    
    echo "âœ… Connexion Ã  la base de donnÃ©es rÃ©ussie !\n\n";
    
    // 1. VÃ©rifier et corriger la table maintenance_schedules
    echo "1. ğŸ”§ Correction de la table maintenance_schedules...\n";
    
    // Ajouter la colonne vehicle_name si elle n'existe pas
    try {
        $sql = "ALTER TABLE maintenance_schedules ADD COLUMN vehicle_name VARCHAR(100) DEFAULT 'VÃ©hicule Test'";
        $pdo->exec($sql);
        echo "   âœ… Colonne vehicle_name ajoutÃ©e\n";
    } catch (PDOException $e) {
        if (strpos($e->getMessage(), 'Duplicate column name') !== false) {
            echo "   âœ… Colonne vehicle_name existe dÃ©jÃ \n";
        } else {
            echo "   âš ï¸ Erreur vehicle_name : " . $e->getMessage() . "\n";
        }
    }
    
    // Mettre Ã  jour les enregistrements existants
    $sql = "UPDATE maintenance_schedules SET vehicle_name = 'VÃ©hicule Test' WHERE vehicle_name IS NULL OR vehicle_name = ''";
    $stmt = $pdo->prepare($sql);
    $stmt->execute();
    $updated = $stmt->rowCount();
    echo "   âœ… $updated enregistrements mis Ã  jour avec vehicle_name\n";
    
    // 2. VÃ©rifier et corriger la table notification_logs
    echo "\n2. ğŸ”§ Correction de la table notification_logs...\n";
    
    // Agrandir la colonne notification_type
    try {
        $sql = "ALTER TABLE notification_logs MODIFY COLUMN notification_type VARCHAR(50)";
        $pdo->exec($sql);
        echo "   âœ… Colonne notification_type agrandie\n";
    } catch (PDOException $e) {
        echo "   âš ï¸ Erreur notification_type : " . $e->getMessage() . "\n";
    }
    
    // 3. VÃ©rifier la structure des tables
    echo "\n3. ğŸ“‹ VÃ©rification de la structure...\n";
    
    // Structure de maintenance_schedules
    $sql = "DESCRIBE maintenance_schedules";
    $stmt = $pdo->prepare($sql);
    $stmt->execute();
    $columns = $stmt->fetchAll();
    
    echo "   ğŸ“… Table maintenance_schedules :\n";
    foreach ($columns as $column) {
        echo "      - {$column['Field']} ({$column['Type']})\n";
    }
    
    // Structure de notification_logs
    $sql = "DESCRIBE notification_logs";
    $stmt = $pdo->prepare($sql);
    $stmt->execute();
    $columns = $stmt->fetchAll();
    
    echo "\n   ğŸ“ Table notification_logs :\n";
    foreach ($columns as $column) {
        echo "      - {$column['Field']} ({$column['Type']})\n";
    }
    
    // 4. Tester avec des donnÃ©es
    echo "\n4. ğŸ§ª Test avec des donnÃ©es...\n";
    
    $sql = "SELECT * FROM maintenance_schedules LIMIT 1";
    $stmt = $pdo->prepare($sql);
    $stmt->execute();
    $maintenance = $stmt->fetch();
    
    if ($maintenance) {
        echo "   âœ… DonnÃ©es de test trouvÃ©es :\n";
        foreach ($maintenance as $key => $value) {
            echo "      - $key : $value\n";
        }
    } else {
        echo "   âš ï¸ Aucune donnÃ©e trouvÃ©e dans maintenance_schedules\n";
    }
    
    echo "\nğŸ‰ CORRECTION TERMINÃ‰E !\n";
    echo "========================================\n";
    echo "âœ… Tables corrigÃ©es\n";
    echo "âœ… Vous pouvez maintenant relancer le script de rappels\n";
    
} catch (Exception $e) {
    echo "âŒ Erreur : " . $e->getMessage() . "\n";
    exit(1);
}

