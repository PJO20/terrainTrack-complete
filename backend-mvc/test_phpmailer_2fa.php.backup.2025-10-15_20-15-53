<?php

require_once 'vendor/autoload.php';

use App\Service\TwoFactorService;
use App\Service\EmailNotificationService;
use App\Repository\UserRepository;
use App\Repository\NotificationLogsRepository;

echo "ðŸ§ª Test PHPMailer pour 2FA\n";
echo "===========================\n\n";

try {
    // Connexion PDO directe
    $host = "localhost";
    $dbname = "exemple";
    $username = "root";
    $password = "root";
    $port = 8889;
    
    $pdo = new PDO(
        "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4",
        $username,
        $password,
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]
    );
    
    echo "âœ… Connexion PDO Ã©tablie\n";
    
    // CrÃ©er les repositories avec PDO
    $userRepository = new UserRepository($pdo);
    $notificationLogsRepository = new NotificationLogsRepository($pdo);
    
    // CrÃ©er le service email
    $emailService = new EmailNotificationService(
        $userRepository, 
        $notificationLogsRepository
    );
    
    echo "âœ… EmailNotificationService crÃ©Ã©\n";
    
    // CrÃ©er le service 2FA avec le service email
    $twoFactorService = new TwoFactorService($emailService);
    echo "âœ… TwoFactorService crÃ©Ã© avec EmailService\n\n";
    
    // GÃ©nÃ©rer un code de test
    $testCode = $twoFactorService->generateOtpCode();
    echo "ðŸ” Code de test gÃ©nÃ©rÃ©: $testCode\n\n";
    
    // Envoyer un email de test avec PHPMailer
    echo "ðŸ“¤ Envoi d'un email 2FA via PHPMailer Ã  pjorsini20@gmail.com...\n";
    $result = $twoFactorService->sendVerificationCode(1, 'pjorsini20@gmail.com', $testCode);
    
    if ($result) {
        echo "âœ… Email envoyÃ© avec succÃ¨s via PHPMailer !\n";
        echo "ðŸ“§ VÃ©rifiez votre boÃ®te mail: pjorsini20@gmail.com\n";
        echo "ðŸ” Code Ã  utiliser: $testCode\n";
        echo "ðŸ“‹ VÃ©rifiez aussi les logs pour plus de dÃ©tails\n";
    } else {
        echo "âŒ Erreur lors de l'envoi de l'email via PHPMailer\n";
        echo "ðŸ“‹ VÃ©rifiez les logs pour plus de dÃ©tails\n";
    }
    
} catch (Exception $e) {
    echo "âŒ Erreur: " . $e->getMessage() . "\n";
    echo "ðŸ“ Trace: " . $e->getTraceAsString() . "\n";
}

echo "\nðŸ Test terminÃ©\n";

?>
