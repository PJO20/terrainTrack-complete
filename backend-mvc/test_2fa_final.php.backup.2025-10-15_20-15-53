<?php

require_once 'vendor/autoload.php';

use App\Service\TwoFactorService;
use App\Service\EmailNotificationService;
use App\Repository\UserRepository;
use App\Repository\NotificationLogsRepository;

echo "ðŸ” Test 2FA Final - Email RÃ©el\n";
echo "===============================\n\n";

try {
    // Connexion PDO directe
    $host = "localhost";
    $dbname = "exemple";
    $username = "root";
    $password = "root";
    $port = 8889;
    
    $pdo = new PDO(
        "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4",
        $username,
        $password,
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]
    );
    
    // CrÃ©er les services
    $userRepository = new UserRepository($pdo);
    $notificationLogsRepository = new NotificationLogsRepository($pdo);
    $emailService = new EmailNotificationService($userRepository, $notificationLogsRepository);
    $twoFactorService = new TwoFactorService($emailService);
    
    echo "âœ… Services crÃ©Ã©s\n\n";
    
    // Simuler une connexion admin
    $adminUserId = 7; // ID de l'admin Momo
    $adminEmail = 'pjorsini20@gmail.com'; // Email de notification
    
    echo "ðŸ‘¤ Simulation connexion admin :\n";
    echo "   User ID: $adminUserId\n";
    echo "   Email notification: $adminEmail\n\n";
    
    // GÃ©nÃ©rer et stocker un code 2FA
    $code = $twoFactorService->generateOtpCode();
    $stored = $twoFactorService->storeOtpCode($adminUserId, $code);
    
    if (!$stored) {
        echo "âŒ Erreur lors du stockage du code\n";
        exit;
    }
    
    echo "ðŸ” Code 2FA gÃ©nÃ©rÃ© et stockÃ©: $code\n\n";
    
    // Envoyer l'email 2FA
    echo "ðŸ“¤ Envoi de l'email 2FA...\n";
    echo "========================\n";
    
    $emailSent = $twoFactorService->sendVerificationCode($adminUserId, $adminEmail, $code);
    
    if ($emailSent) {
        echo "âœ… EMAIL 2FA ENVOYÃ‰ AVEC SUCCÃˆS !\n";
        echo "ðŸ“§ Destinataire: $adminEmail\n";
        echo "ðŸ” Code: $code\n";
        echo "â° Expire dans: 10 minutes\n\n";
        
        echo "ðŸ” VÃ‰RIFIEZ MAINTENANT :\n";
        echo "========================\n";
        echo "1. ðŸ“§ BoÃ®te de rÃ©ception: pjorsini20@gmail.com\n";
        echo "2. ðŸ“ Dossier Spam/Courrier indÃ©sirable\n";
        echo "3. ðŸ“‚ Onglet Promotions (Gmail)\n";
        echo "4. â° Attendez 1-2 minutes si nÃ©cessaire\n\n";
        
        echo "ðŸ“‹ Sujet de l'email: 'ðŸ” Code de vÃ©rification TerrainTrack - $code'\n";
        
    } else {
        echo "âŒ ERREUR lors de l'envoi de l'email\n";
    }
    
} catch (Exception $e) {
    echo "âŒ Erreur: " . $e->getMessage() . "\n";
}

echo "\nðŸ Test terminÃ©\n";

?>
