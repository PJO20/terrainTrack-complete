<?php
/**
 * Test de sauvegarde des prÃ©fÃ©rences
 */

echo "ðŸ” Test de sauvegarde des prÃ©fÃ©rences\n";
echo "====================================\n\n";

// Inclure les dÃ©pendances
require_once __DIR__ . '/vendor/autoload.php';

try {
    // CrÃ©er les services nÃ©cessaires
    $host = 'localhost';
    $port = '8889';
    $dbname = 'exemple';
    $username = 'root';
    $password = 'root';
    
    $dsn = "mysql:host=$host;port=$port;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
    
    // CrÃ©er les repositories
    $userRepository = new \App\Repository\UserRepository($pdo);
    $preferencesRepository = new \App\Repository\NotificationPreferencesRepository($pdo);
    
    echo "âœ… Services crÃ©Ã©s avec succÃ¨s\n";
    
    // RÃ©cupÃ©rer l'utilisateur (ID 7 = momo@gmail.com)
    $userId = 7;
    $user = $userRepository->findById($userId);
    
    if (!$user) {
        echo "âŒ Utilisateur non trouvÃ©\n";
        exit;
    }
    echo "âœ… Utilisateur trouvÃ©: " . $user->getName() . " (" . $user->getEmail() . ")\n";
    
    // RÃ©cupÃ©rer les prÃ©fÃ©rences actuelles
    $preferences = $preferencesRepository->findByUserId($userId);
    echo "âœ… PrÃ©fÃ©rences actuelles:\n";
    if ($preferences) {
        foreach ($preferences as $key => $value) {
            echo "  - $key: " . ($value ? 'Oui' : 'Non') . "\n";
        }
    } else {
        echo "  Aucune prÃ©fÃ©rence trouvÃ©e\n";
    }
    
    // Tester la sauvegarde avec de nouvelles donnÃ©es
    echo "\nðŸ“ Test de sauvegarde...\n";
    
    $newPreferences = [
        'user_id' => $userId,
        'email_notifications' => true,
        'sms_notifications' => false,
        'intervention_assignments' => true,
        'maintenance_reminders' => true,
        'critical_alerts' => true,
        'reminder_frequency_days' => 7
    ];
    
    echo "ðŸ“‹ Nouvelles prÃ©fÃ©rences Ã  sauvegarder:\n";
    foreach ($newPreferences as $key => $value) {
        echo "  - $key: " . ($value ? 'Oui' : 'Non') . "\n";
    }
    
    $success = $preferencesRepository->save($newPreferences);
    
    if ($success) {
        echo "âœ… PrÃ©fÃ©rences sauvegardÃ©es avec succÃ¨s !\n";
        
        // VÃ©rifier que les prÃ©fÃ©rences ont Ã©tÃ© mises Ã  jour
        $updatedPreferences = $preferencesRepository->findByUserId($userId);
        echo "\nðŸ“‹ PrÃ©fÃ©rences aprÃ¨s sauvegarde:\n";
        if ($updatedPreferences) {
            foreach ($updatedPreferences as $key => $value) {
                echo "  - $key: " . ($value ? 'Oui' : 'Non') . "\n";
            }
        }
    } else {
        echo "âŒ Ã‰chec de la sauvegarde des prÃ©fÃ©rences\n";
    }
    
} catch (Exception $e) {
    echo "âŒ Erreur: " . $e->getMessage() . "\n";
    echo "ðŸ“ Fichier: " . $e->getFile() . ":" . $e->getLine() . "\n";
}

echo "\nðŸ” Test terminÃ© !\n";
?>
